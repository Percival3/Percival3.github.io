---
import BackgroundEffect from './BackgroundEffect';

// Replace these with your own still frames later, e.g. /backgrounds/day-cowboy.webp
// and /backgrounds/night-gits.webp in the public folder.
const BACKGROUND_ASSETS = {
  day: {
    src: '/cowboy_bebop.jpg',
    objectPosition: '50% 46%',
  },
  night: {
    src: '/Ghost_in_Shell.jpg',
    objectPosition: '50% 30%',
  },
};

// Main tuning table: keep structure, tweak numbers only when swapping screenshots.
const BACKGROUND_TUNING = {
  day: {
    baseColor: '#f6ead7',
    imageOpacity: 0.95,
    saturation: 1.08,
    contrast: 1.03,
    brightness: 1,
    leftGlowOpacity: 0.54,
    rightGlowOpacity: 0.44,
  },
  night: {
    baseColor: '#040913',
    imageOpacity: 0.93,
    saturation: 1.2,
    contrast: 1.12,
    brightness: 0.74,
    dimOverlayOpacity: 0.26,
    macroGridOpacity: 0.17,
    microGridOpacity: 0.12,
    scanlineOpacity: 0.11,
    noiseOpacity: 0.05,
    perspectiveGridOpacity: 0.28,
    cyanGlowOpacity: 0.3,
    magentaGlowOpacity: 0.23,
    violetGlowOpacity: 0.2,
  },
};

const sceneVars = {
  '--day-base-color': BACKGROUND_TUNING.day.baseColor,
  '--night-base-color': BACKGROUND_TUNING.night.baseColor,
  '--night-image-opacity': String(BACKGROUND_TUNING.night.imageOpacity),
  '--day-left-glow-opacity': String(BACKGROUND_TUNING.day.leftGlowOpacity),
  '--day-right-glow-opacity': String(BACKGROUND_TUNING.day.rightGlowOpacity),
  '--night-dim-opacity': String(BACKGROUND_TUNING.night.dimOverlayOpacity),
  '--night-macro-grid-opacity': String(BACKGROUND_TUNING.night.macroGridOpacity),
  '--night-micro-grid-opacity': String(BACKGROUND_TUNING.night.microGridOpacity),
  '--night-scanline-opacity': String(BACKGROUND_TUNING.night.scanlineOpacity),
  '--night-noise-opacity': String(BACKGROUND_TUNING.night.noiseOpacity),
  '--night-perspective-grid-opacity': String(BACKGROUND_TUNING.night.perspectiveGridOpacity),
  '--night-cyan-glow-opacity': String(BACKGROUND_TUNING.night.cyanGlowOpacity),
  '--night-magenta-glow-opacity': String(BACKGROUND_TUNING.night.magentaGlowOpacity),
  '--night-violet-glow-opacity': String(BACKGROUND_TUNING.night.violetGlowOpacity),
} as const;
---

<div class="background-scene" style={sceneVars}>
  <div class="fixed inset-0 -z-50 h-full w-full base-layer transition-colors duration-700"></div>

  <div
    class="fixed inset-x-0 -z-40 pointer-events-none overflow-hidden select-none background-frame"
    style="top: 0; height: 100vh; height: 100dvh;"
  >
    <img
      src={BACKGROUND_ASSETS.day.src}
      alt="Day Background"
      class="absolute inset-0 w-full h-full object-cover scene-image day-image"
      style={{
        objectPosition: BACKGROUND_ASSETS.day.objectPosition,
        filter: `saturate(${BACKGROUND_TUNING.day.saturation}) contrast(${BACKGROUND_TUNING.day.contrast}) brightness(${BACKGROUND_TUNING.day.brightness})`,
      }}
    />

    <img
      src={BACKGROUND_ASSETS.night.src}
      alt="Night Background"
      class="absolute inset-0 w-full h-full object-cover scene-image night-image"
      style={{
        objectPosition: BACKGROUND_ASSETS.night.objectPosition,
        filter: `saturate(${BACKGROUND_TUNING.night.saturation}) contrast(${BACKGROUND_TUNING.night.contrast}) brightness(${BACKGROUND_TUNING.night.brightness})`,
      }}
    />

    <div class="absolute inset-0 day-layer day-film-wash"></div>
    <div class="absolute inset-0 night-layer night-cyber-wash"></div>
    <div class="absolute inset-0 night-layer night-dim-overlay"></div>
  </div>

  <div
    class="fixed inset-x-0 -z-30 pointer-events-none"
    style="top: 0; height: 100vh; height: 100dvh;"
  >
    <div class="absolute inset-0 day-layer day-grid"></div>

    <div class="absolute inset-0 night-layer night-macro-grid"></div>
    <div class="absolute inset-0 night-layer night-micro-grid"></div>
    <div class="absolute inset-0 night-layer night-scanlines"></div>
    <div class="absolute inset-0 night-layer night-noise"></div>

    <div class="absolute -top-32 left-[8%] h-[360px] w-[360px] rounded-full bg-[#ffb7a1]/45 blur-[120px] day-left-glow day-layer"></div>
    <div class="absolute -top-28 right-[10%] h-[320px] w-[320px] rounded-full bg-[#ffe3aa]/40 blur-[110px] day-right-glow day-layer"></div>

    <div class="absolute -top-24 left-0 right-0 m-auto h-[560px] w-[560px] rounded-full bg-[#6ef6ff]/22 blur-[146px] mix-blend-screen night-layer night-cyan-glow"></div>
    <div class="absolute top-16 right-[12%] h-[420px] w-[420px] rounded-full bg-[#ff2ea6]/20 blur-[136px] mix-blend-screen night-layer night-magenta-glow"></div>
    <div class="absolute top-14 left-[10%] h-[360px] w-[360px] rounded-full bg-[#6e4cff]/18 blur-[128px] mix-blend-screen night-layer night-violet-glow"></div>

    <div class="absolute inset-x-0 bottom-[-8%] h-[42%] night-layer cyber-perspective-grid"></div>
  </div>

  <div
    class="fixed inset-x-0 -z-20 pointer-events-none"
    style="top: 0; height: 100vh; height: 100dvh;"
  >
    <BackgroundEffect client:only="react" />
  </div>
</div>

<style>
  .background-scene .base-layer {
    background: var(--day-base-color);
  }

  :global(html.dark) .background-scene .base-layer {
    background: var(--night-base-color);
  }

  .background-scene .scene-image {
    -webkit-mask-image: none;
    mask-image: none;
  }

  .background-scene .day-image {
    opacity: 0.92;
    transition: opacity 1s ease-in-out;
  }

  :global(html.dark) .background-scene .day-image {
    opacity: 0;
  }

  .background-scene .night-image {
    opacity: 0;
    transition: opacity 0.7s ease-in-out;
  }

  :global(html.dark) .background-scene .night-image {
    opacity: var(--night-image-opacity);
  }

  .background-scene .day-layer {
    opacity: 1;
    transition: opacity 0.7s ease;
  }

  :global(html.dark) .background-scene .day-layer {
    opacity: 0;
  }

  .background-scene .night-layer {
    opacity: 0;
    transition: opacity 0.7s ease;
  }

  :global(html.dark) .background-scene .night-layer {
    opacity: var(--night-layer-opacity, 1);
  }

  .background-scene .day-film-wash {
    background:
      radial-gradient(circle_at_18%_24%, rgba(255, 193, 162, 0.22), transparent 46%),
      radial-gradient(circle_at_78%_14%, rgba(255, 233, 179, 0.2), transparent 42%),
      linear-gradient(to bottom, rgba(255, 249, 241, 0.08), rgba(244, 229, 206, 0.28));
  }

  .background-scene .night-cyber-wash {
    --night-layer-opacity: 1;
    background:
      radial-gradient(circle_at_16%_20%, rgba(0, 255, 232, 0.22), transparent 36%),
      radial-gradient(circle_at_83%_16%, rgba(255, 46, 166, 0.16), transparent 34%),
      radial-gradient(circle_at_54%_3%, rgba(116, 76, 255, 0.18), transparent 36%),
      linear-gradient(to bottom, rgba(6, 16, 34, 0.2), rgba(2, 9, 19, 0.9));
  }

  .background-scene .night-dim-overlay {
    --night-layer-opacity: var(--night-dim-opacity);
    background: black;
  }

  .background-scene .day-grid {
    background-image:
      linear-gradient(to right, #8b8b8b14 1px, transparent 1px),
      linear-gradient(to bottom, #8b8b8b14 1px, transparent 1px);
    background-size: 24px 24px;
    opacity: 0.35;
  }

  .background-scene .night-macro-grid {
    --night-layer-opacity: var(--night-macro-grid-opacity);
    background-image:
      linear-gradient(90deg, rgba(0, 255, 232, 0.19) 1px, transparent 1px),
      linear-gradient(0deg, rgba(255, 46, 166, 0.14) 1px, transparent 1px);
    background-size: 96px 96px;
  }

  .background-scene .night-micro-grid {
    --night-layer-opacity: var(--night-micro-grid-opacity);
    background-image:
      linear-gradient(rgba(0, 255, 232, 0.09) 1px, transparent 1px),
      linear-gradient(90deg, rgba(134, 93, 255, 0.08) 1px, transparent 1px);
    background-size: 26px 26px;
    mix-blend-mode: screen;
  }

  .background-scene .night-scanlines {
    --night-layer-opacity: var(--night-scanline-opacity);
    background-image: repeating-linear-gradient(
      to bottom,
      rgba(0, 255, 232, 0.17) 0px,
      rgba(0, 255, 232, 0.17) 1px,
      transparent 1px,
      transparent 3px
    );
    mix-blend-mode: screen;
  }

  .background-scene .night-noise {
    --night-layer-opacity: var(--night-noise-opacity);
    background-image: repeating-linear-gradient(
      90deg,
      rgba(0, 255, 232, 0.03) 0px,
      rgba(0, 255, 232, 0.03) 1px,
      transparent 1px,
      transparent 5px
    );
    mix-blend-mode: overlay;
  }

  .background-scene .day-left-glow {
    opacity: var(--day-left-glow-opacity);
  }

  .background-scene .day-right-glow {
    opacity: var(--day-right-glow-opacity);
  }

  .background-scene .night-cyan-glow {
    --night-layer-opacity: var(--night-cyan-glow-opacity);
  }

  .background-scene .night-magenta-glow {
    --night-layer-opacity: var(--night-magenta-glow-opacity);
  }

  .background-scene .night-violet-glow {
    --night-layer-opacity: var(--night-violet-glow-opacity);
  }

  .background-scene .cyber-perspective-grid {
    --night-layer-opacity: var(--night-perspective-grid-opacity);
    background-image:
      linear-gradient(rgba(0, 255, 232, 0.18) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 255, 232, 0.16) 1px, transparent 1px);
    background-size: 44px 44px;
    transform: perspective(780px) rotateX(67deg) scale(1.15);
    transform-origin: bottom center;
    mix-blend-mode: screen;
  }
</style>

<script is:inline>
  (() => {
    const scene = document.querySelector('.background-scene');
    const frame = scene?.querySelector('.background-frame');
    const dayImage = scene?.querySelector('.day-image');
    const nightImage = scene?.querySelector('.night-image');
    const html = document.documentElement;
    if (!scene || !frame || !dayImage || !nightImage) return;

    const getCurrentRatio = () => {
      const activeImage = html.classList.contains('dark') ? nightImage : dayImage;
      const width = activeImage.naturalWidth || 16;
      const height = activeImage.naturalHeight || 9;
      return width / height;
    };

    const DAY_PALETTES = {
      darkSurface: {
        strong: '#f2e6d4',
        body: '#ebdecb',
        muted: '#d8cab6',
        soft: '#cdbda9',
        link: '#7eb5ff',
        inlineCode: '#ffd5ee',
        inlineCodeBg: 'rgba(20, 24, 38, 0.5)',
        blockquoteBg: 'rgba(28, 44, 72, 0.32)',
        blockquoteBorder: 'rgba(123, 175, 255, 0.95)',
        hr: 'rgba(255, 255, 255, 0.28)',
      },
      midSurface: {
        strong: '#f7ead8',
        body: '#f0e1cf',
        muted: '#dccbb8',
        soft: '#cfbfac',
        link: '#6fa8ff',
        inlineCode: '#ffd4ec',
        inlineCodeBg: 'rgba(24, 28, 42, 0.52)',
        blockquoteBg: 'rgba(30, 48, 78, 0.34)',
        blockquoteBorder: 'rgba(110, 168, 255, 0.95)',
        hr: 'rgba(255, 255, 255, 0.3)',
      },
      lightSurface: {
        strong: '#2f2620',
        body: '#3d332b',
        muted: '#5a4a3e',
        soft: '#766658',
        link: '#1f64d1',
        inlineCode: '#892d56',
        inlineCodeBg: 'rgba(255, 248, 239, 0.72)',
        blockquoteBg: 'rgba(232, 218, 199, 0.62)',
        blockquoteBorder: 'rgba(38, 94, 188, 0.82)',
        hr: 'rgba(92, 72, 54, 0.24)',
      },
    };

    const NIGHT_PALETTES = {
      darkSurface: {
        strong: '#ebf7ff',
        body: '#d3e8f8',
        muted: '#b8d4e8',
        soft: '#98b7cd',
        link: '#8ed0ff',
        inlineCode: '#f8bcff',
        inlineCodeBg: 'rgba(24, 31, 52, 0.64)',
        blockquoteBg: 'rgba(14, 26, 52, 0.46)',
        blockquoteBorder: 'rgba(110, 198, 255, 0.96)',
        hr: 'rgba(123, 221, 255, 0.34)',
      },
      brightSurface: {
        strong: '#e4f2ff',
        body: '#cbdef0',
        muted: '#acc7db',
        soft: '#8ea8c0',
        link: '#79c3ff',
        inlineCode: '#f7b2ff',
        inlineCodeBg: 'rgba(20, 28, 50, 0.68)',
        blockquoteBg: 'rgba(11, 22, 46, 0.5)',
        blockquoteBorder: 'rgba(92, 182, 255, 0.96)',
        hr: 'rgba(108, 205, 255, 0.36)',
      },
    };

    let dayPalette = DAY_PALETTES.darkSurface;
    let nightPalette = NIGHT_PALETTES.darkSurface;

    const setAdaptiveVars = (palette) => {
      html.style.setProperty('--adaptive-text-strong', palette.strong);
      html.style.setProperty('--adaptive-text-body', palette.body);
      html.style.setProperty('--adaptive-text-muted', palette.muted);
      html.style.setProperty('--adaptive-text-soft', palette.soft);
      html.style.setProperty('--adaptive-link', palette.link);
      html.style.setProperty('--adaptive-inline-code', palette.inlineCode);
      html.style.setProperty('--adaptive-inline-code-bg', palette.inlineCodeBg);
      html.style.setProperty('--adaptive-blockquote-bg', palette.blockquoteBg);
      html.style.setProperty('--adaptive-blockquote-border', palette.blockquoteBorder);
      html.style.setProperty('--adaptive-hr', palette.hr);
    };

    const applyThemePalette = () => {
      setAdaptiveVars(html.classList.contains('dark') ? nightPalette : dayPalette);
    };

    const srgbToLinear = (channel) => {
      const value = channel / 255;
      return value <= 0.04045
        ? value / 12.92
        : Math.pow((value + 0.055) / 1.055, 2.4);
    };

    const getRelativeLuminance = (color) => {
      return (
        0.2126 * srgbToLinear(color.r) +
        0.7152 * srgbToLinear(color.g) +
        0.0722 * srgbToLinear(color.b)
      );
    };

    const waitForImageReady = (image) => {
      return new Promise((resolve) => {
        if (image.complete && image.naturalWidth > 0 && image.naturalHeight > 0) {
          resolve();
          return;
        }

        image.addEventListener('load', () => resolve(), { once: true });
        image.addEventListener('error', () => resolve(), { once: true });
      });
    };

    const getAverageColor = (image) => {
      const sourceWidth = image.naturalWidth || 0;
      const sourceHeight = image.naturalHeight || 0;
      if (sourceWidth === 0 || sourceHeight === 0) return null;

      const sampleWidth = Math.max(28, Math.min(76, Math.round(sourceWidth / 26)));
      const sampleHeight = Math.max(28, Math.min(76, Math.round(sourceHeight / 26)));

      const canvas = document.createElement('canvas');
      canvas.width = sampleWidth;
      canvas.height = sampleHeight;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      if (!ctx) return null;

      ctx.drawImage(image, 0, 0, sampleWidth, sampleHeight);
      const { data } = ctx.getImageData(0, 0, sampleWidth, sampleHeight);

      let rTotal = 0;
      let gTotal = 0;
      let bTotal = 0;
      let count = 0;

      for (let i = 0; i < data.length; i += 16) {
        const alpha = data[i + 3];
        if (alpha < 16) continue;
        rTotal += data[i];
        gTotal += data[i + 1];
        bTotal += data[i + 2];
        count += 1;
      }

      if (count === 0) return null;

      return {
        r: rTotal / count,
        g: gTotal / count,
        b: bTotal / count,
      };
    };

    const pickDayPalette = (luminance) => {
      if (luminance >= 0.58) return DAY_PALETTES.lightSurface;
      if (luminance >= 0.45) return DAY_PALETTES.midSurface;
      return DAY_PALETTES.darkSurface;
    };

    const pickNightPalette = (luminance) => {
      if (luminance >= 0.38) return NIGHT_PALETTES.brightSurface;
      return NIGHT_PALETTES.darkSurface;
    };

    const refreshAdaptivePalette = async () => {
      await Promise.all([waitForImageReady(dayImage), waitForImageReady(nightImage)]);

      const dayColor = getAverageColor(dayImage);
      const nightColor = getAverageColor(nightImage);

      if (dayColor) {
        dayPalette = pickDayPalette(getRelativeLuminance(dayColor));
      }

      if (nightColor) {
        nightPalette = pickNightPalette(getRelativeLuminance(nightColor));
      }

      applyThemePalette();
    };

    const updateSceneSize = () => {
      const nav = document.querySelector('header');
      const navHeight = nav ? Math.round(nav.getBoundingClientRect().height) : 56;
      const visibleHeight = Math.max(window.innerHeight - navHeight, 320);
      const ratio = getCurrentRatio();
      const imageFitHeight = window.innerWidth / ratio;

      // Let the cover follow image ratio while keeping a readable hero on narrow screens.
      const heroHeight = Math.round(Math.max(visibleHeight * 0.68, Math.min(visibleHeight, imageFitHeight)));

      scene.style.setProperty('--nav-height', `${navHeight}px`);
      scene.style.setProperty('--hero-scene-height', `${heroHeight}px`);
    };

    const updateAll = () => {
      updateSceneSize();
      applyThemePalette();
    };

    const onImageReady = () => {
      updateAll();
    };

    if (!dayImage.complete) {
      dayImage.addEventListener('load', onImageReady, { once: true });
    }

    if (!nightImage.complete) {
      nightImage.addEventListener('load', onImageReady, { once: true });
    }

    const themeObserver = new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          updateAll();
        }
      }
    });

    themeObserver.observe(html, {
      attributes: true,
      attributeFilter: ['class'],
    });

    refreshAdaptivePalette();
    updateAll();
    window.addEventListener('resize', updateAll, { passive: true });
  })();
</script>
