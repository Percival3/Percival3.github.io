---
// src/pages/[lang]/blog/index.astro
// 博客文章列表页
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Calendar, Clock, ArrowRight } from 'lucide-react';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { calculateReadingStats } from '../../../utils/reading-time';

export async function getStaticPaths() {
  return [
    { params: { lang: 'zh' } },
    { params: { lang: 'en' } },
    { params: { lang: 'ja' } },
  ];
}

const { lang } = Astro.params;

// 获取所有文章
const allPosts = await getCollection('posts');

// 过滤掉草稿,并按日期排序
const publishedPosts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 多语言标题
const pageTitle = {
  zh: '博客文章',
  en: 'Blog Posts',
  ja: 'ブログ記事',
};

const texts = {
  zh: {
    title: '博客',
    subtitle: '分享技术见解与学习笔记',
    readMore: '阅读全文',
    minRead: '分钟',
    noPosts: '暂无文章',
  },
  en: {
    title: 'Blog',
    subtitle: 'Sharing tech insights and learning notes',
    readMore: 'Read More',
    minRead: 'min',
    noPosts: 'No posts yet',
  },
  ja: {
    title: 'ブログ',
    subtitle: '技術的な洞察と学習ノートの共有',
    readMore: '続きを読む',
    minRead: '分',
    noPosts: '記事がありません',
  },
};

const t = texts[lang as keyof typeof texts] || texts.zh;

// 格式化日期
function formatDate(date: Date, locale: string): string {
  const localeMap = {
    zh: 'zh-CN',
    en: 'en-US',
    ja: 'ja-JP',
  };
  return date.toLocaleDateString(localeMap[locale as keyof typeof localeMap] || 'zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title={pageTitle[lang as keyof typeof pageTitle] || 'Blog'} lang={lang}>
  <div class="page-shell max-w-4xl">

    <div class="page-hero">
      <div class="page-hero-card">
        <h1 class="page-title">{t.title}</h1>
        <p class="page-subtitle">{t.subtitle}</p>
      </div>
    </div>

    {publishedPosts.length > 0 ? (
      <div class="space-y-8">
        {publishedPosts.map((post) => {
          const stats = calculateReadingStats(post.body || '');
          const postUrl = getRelativeLocaleUrl(lang, `blog/${post.id.replace(/\.mdx?$/, '')}`);

          return (
            <article class="group page-card p-6 md:p-8 hover:shadow-xl hover:shadow-blue-500/10">

              {post.data.heroImage && (
                <a href={postUrl}>
                  <img
                    src={post.data.heroImage}
                    alt={post.data.title}
                    class="w-full h-40 md:h-52 object-cover rounded-xl mb-5 group-hover:scale-[1.02] transition-transform duration-300"
                  />
                </a>
              )}

              <a href={postUrl}>
                <h2 class="text-2xl md:text-3xl font-bold mb-3 text-[var(--adaptive-text-strong)] dark:text-gray-100 group-hover:opacity-90 transition-opacity">
                  {post.data.title}
                </h2>
              </a>

              <div class="flex flex-wrap items-center gap-3 md:gap-4 text-sm text-[var(--adaptive-text-muted)] dark:text-gray-400 mb-4">
                <div class="flex items-center gap-1.5">
                  <Calendar className="w-4 h-4" />
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDate(post.data.pubDate, lang)}
                  </time>
                </div>
                <div class="w-px h-4 dark:bg-gray-700" style="background-color: var(--adaptive-text-muted); opacity: 0.45;"></div>
                <div class="flex items-center gap-1.5">
                  <Clock className="w-4 h-4" />
                  <span>{stats.readingTime} {t.minRead}</span>
                </div>
              </div>

              <p class="text-[var(--adaptive-text-body)] dark:text-gray-300 mb-4 line-clamp-2">
                {post.data.description}
              </p>

              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {post.data.tags.map(tag => (
                    <span class="accent-chip px-3 py-1 text-xs font-medium rounded-full">
                      {tag}
                    </span>
                  ))}
                </div>
              )}

              <a
                href={postUrl}
                class="accent-link inline-flex items-center gap-2 font-medium hover:gap-3 transition-all group/link"
              >
                <span>{t.readMore}</span>
                <ArrowRight className="w-4 h-4 group-hover/link:translate-x-1 transition-transform" />
              </a>

            </article>
          );
        })}
      </div>
    ) : (
      <div class="page-empty">
        <p class="text-xl">{t.noPosts}</p>
      </div>
    )}

  </div>
</Layout>
