---
// src/pages/[lang]/research/index.astro
// 学术研究列表页 (论文 + 数据集)
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Calendar, ArrowRight, FileText, Database, ExternalLink, BookOpen } from 'lucide-react';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  return [
    { params: { lang: 'zh' } },
    { params: { lang: 'en' } },
    { params: { lang: 'ja' } },
  ];
}

const { lang } = Astro.params;

const allResearch = await getCollection('research');
const published = allResearch
  .filter(item => !item.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const papers = published.filter(item => item.data.type === 'paper');
const datasets = published.filter(item => item.data.type === 'dataset');

const texts = {
  zh: {
    pageTitle: '学术研究',
    title: '学术研究',
    subtitle: '论文发表与数据集',
    all: '全部',
    papers: '论文',
    datasets: '数据集',
    readMore: '查看详情',
    noItems: '暂无内容',
    venue: '发表于',
  },
  en: {
    pageTitle: 'Research',
    title: 'Research',
    subtitle: 'Papers and Datasets',
    all: 'All',
    papers: 'Papers',
    datasets: 'Datasets',
    readMore: 'Read More',
    noItems: 'No items yet',
    venue: 'Published at',
  },
  ja: {
    pageTitle: '研究',
    title: '研究',
    subtitle: '論文とデータセット',
    all: 'すべて',
    papers: '論文',
    datasets: 'データセット',
    readMore: '詳細を見る',
    noItems: 'まだコンテンツがありません',
    venue: '発表先',
  },
};

const t = texts[lang as keyof typeof texts] || texts.zh;

function formatDate(date: Date, locale: string): string {
  const localeMap = { zh: 'zh-CN', en: 'en-US', ja: 'ja-JP' };
  return date.toLocaleDateString(localeMap[locale as keyof typeof localeMap] || 'zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title={t.pageTitle} lang={lang}>
  <div class="page-shell max-w-4xl">

    <div class="page-hero">
      <div class="page-hero-card">
        <h1 class="page-title">{t.title}</h1>
        <p class="page-subtitle">{t.subtitle}</p>
      </div>
    </div>

    <div class="flex justify-center gap-4 mb-10">
      <span class="glass-chip px-4 py-2 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
        {t.all} ({published.length})
      </span>
      <span class="glass-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400">
        <span class="inline-flex items-center gap-1.5"><FileText className="w-3.5 h-3.5" /> {t.papers} ({papers.length})</span>
      </span>
      <span class="glass-chip px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400">
        <span class="inline-flex items-center gap-1.5"><Database className="w-3.5 h-3.5" /> {t.datasets} ({datasets.length})</span>
      </span>
    </div>

    {published.length > 0 ? (
      <div class="space-y-6">
        {published.map((item) => {
          const itemUrl = getRelativeLocaleUrl(lang, `research/${item.id.replace(/\.mdx?$/, '')}`);
          const isPaper = item.data.type === 'paper';

          return (
            <article class="group page-card p-6 md:p-8 hover:shadow-xl hover:shadow-blue-500/10">

              <!-- 类型标识 + 标题 -->
              <div class="flex items-start gap-4">
                <div class={`flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center ${isPaper ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'}`}>
                  {isPaper ? <BookOpen className="w-5 h-5" /> : <Database className="w-5 h-5" />}
                </div>
                <div class="flex-1 min-w-0">
                  <a href={itemUrl}>
                    <h2 class="text-xl md:text-2xl font-bold mb-2 text-[var(--adaptive-text-strong)] dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                      {item.data.title}
                    </h2>
                  </a>

                  <!-- 元信息 -->
                  <div class="flex flex-wrap items-center gap-3 text-sm text-[var(--adaptive-text-muted)] dark:text-gray-400 mb-3">
                    <div class="flex items-center gap-1.5">
                      <Calendar className="w-4 h-4" />
                      <time datetime={item.data.pubDate.toISOString()}>
                        {formatDate(item.data.pubDate, lang)}
                      </time>
                    </div>
                    {item.data.venue && (
                      <>
                        <div class="w-px h-4 dark:bg-gray-700" style="background-color: var(--adaptive-text-muted); opacity: 0.45;"></div>
                        <span class="text-blue-600 dark:text-blue-400 font-medium">{item.data.venue}</span>
                      </>
                    )}
                  </div>

                  <p class="text-[var(--adaptive-text-body)] dark:text-gray-300 mb-4 line-clamp-2">
                    {item.data.description}
                  </p>

                  <!-- 标签 -->
                  {item.data.tags && item.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-4">
                      {item.data.tags.map(tag => (
                        <span class="px-3 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}

                  <!-- 操作链接 -->
                  <div class="flex flex-wrap items-center gap-4">
                    <a
                      href={itemUrl}
                      class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 font-medium hover:gap-3 transition-all group/link"
                    >
                      <span>{t.readMore}</span>
                      <ArrowRight className="w-4 h-4 group-hover/link:translate-x-1 transition-transform" />
                    </a>

                    {item.data.pdfUrl && (
                      <a
                        href={item.data.pdfUrl}
                        target="_blank"
                        class="inline-flex items-center gap-1.5 text-sm text-[var(--adaptive-text-soft)] dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                      >
                        <FileText className="w-4 h-4" />
                        <span>PDF</span>
                        <ExternalLink className="w-3 h-3" />
                      </a>
                    )}

                    {item.data.datasetUrl && (
                      <a
                        href={item.data.datasetUrl}
                        target="_blank"
                        class="inline-flex items-center gap-1.5 text-sm text-[var(--adaptive-text-soft)] dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors"
                      >
                        <Database className="w-4 h-4" />
                        <span>Dataset</span>
                        <ExternalLink className="w-3 h-3" />
                      </a>
                    )}

                    {item.data.doi && (
                      <a
                        href={`https://doi.org/${item.data.doi}`}
                        target="_blank"
                        class="inline-flex items-center gap-1.5 text-sm text-[var(--adaptive-text-soft)] dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                      >
                        <span>DOI</span>
                        <ExternalLink className="w-3 h-3" />
                      </a>
                    )}
                  </div>
                </div>
              </div>

            </article>
          );
        })}
      </div>
    ) : (
      <div class="page-empty">
        <p class="text-xl">{t.noItems}</p>
      </div>
    )}

  </div>
</Layout>
